<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Examples | Keel</title>
    <meta name="description" content="keel examples">
    
    <meta name="keywords" content="kubernetes keel template manifest example">
    <link rel="preload" href="/assets/css/0.styles.1eab4a7b.css" as="style"><link rel="preload" href="/assets/js/app.36122d6f.js" as="script"><link rel="preload" href="/assets/js/2.dacee0f1.js" as="script"><link rel="preload" href="/assets/js/8.e82c739a.js" as="script"><link rel="preload" href="/assets/js/3.3918a260.js" as="script"><link rel="prefetch" href="/assets/js/4.00cb3c3f.js"><link rel="prefetch" href="/assets/js/5.59349796.js"><link rel="prefetch" href="/assets/js/6.d94577c7.js"><link rel="prefetch" href="/assets/js/7.b6f9273d.js"><link rel="prefetch" href="/assets/js/9.0164cc35.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1eab4a7b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo_small.png" alt="Keel" class="logo"> <span class="site-name can-hide">Keel</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/" class="nav-link">Guide</a></div><div class="nav-item"><a href="/examples/" class="nav-link router-link-exact-active router-link-active">Examples</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">External</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://about.sunstone.dev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Templating
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://webhookrelay.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Webhooks &amp; Tunneling
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/keel-hq/keel" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/" class="nav-link">Guide</a></div><div class="nav-item"><a href="/examples/" class="nav-link router-link-exact-active router-link-active">Examples</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">External</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://about.sunstone.dev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Templating
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://webhookrelay.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Webhooks &amp; Tunneling
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/keel-hq/keel" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Examples</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/examples/#example-1-push-to-deploy" class="sidebar-link">Example 1: Push to deploy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/examples/#set-up-github-repository" class="sidebar-link">Set up GitHub repository</a></li><li class="sidebar-sub-header"><a href="/examples/#configure-webhook-relay-forwarding" class="sidebar-link">Configure Webhook Relay forwarding</a></li><li class="sidebar-sub-header"><a href="/examples/#configure-dockerhub-code-repository-webhook" class="sidebar-link">Configure DockerHub (code repository + webhook)</a></li><li class="sidebar-sub-header"><a href="/examples/#deploy-keel-and-your-app" class="sidebar-link">Deploy Keel and your app</a></li><li class="sidebar-sub-header"><a href="/examples/#credentials-for-webhookrelayd-sidecar" class="sidebar-link">Credentials for webhookrelayd sidecar</a></li><li class="sidebar-sub-header"><a href="/examples/#deploying-keel" class="sidebar-link">Deploying Keel</a></li><li class="sidebar-sub-header"><a href="/examples/#deploy-your-app" class="sidebar-link">Deploy your app</a></li><li class="sidebar-sub-header"><a href="/examples/#push-to-update" class="sidebar-link">Push to update</a></li><li class="sidebar-sub-header"><a href="/examples/#conclusion" class="sidebar-link">Conclusion</a></li></ul></li><li><a href="/examples/#example-2-enable-automated-semver-updates" class="sidebar-link">Example 2: Enable automated semver updates</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/examples/#install-keel" class="sidebar-link">Install Keel</a></li><li class="sidebar-sub-header"><a href="/examples/#specify-update-policy" class="sidebar-link">Specify update policy</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="examples"><a href="#examples" aria-hidden="true" class="header-anchor">#</a> Examples</h1> <p>Keel can be used in many different environments with a bunch of various settings. See these examples to understand which configuration suits your needs.</p> <h2 id="example-1-push-to-deploy"><a href="#example-1-push-to-deploy" aria-hidden="true" class="header-anchor">#</a> Example 1: Push to deploy</h2> <p>In this tutorial, we will configure several tools to enable automated Kubernetes updates on Git push. This workflow is mostly useful when developing apps for Kubernetes. For production, we recommend tag approach where a tagged release would trigger an image build and Keel update policies would increase the version.</p> <p><img src="/img/examples/force-workflow.png" alt="Keel Force Workflow"></p> <p>Once a workflow is ready, any push to the master branch (or merge requests from develop/feature branches) will update your app running in Kubernetes.</p> <p>In this tutorial we will use:</p> <ul><li><a href="https://github.com/kubernetes/minikube#what-is-minikube" target="_blank" rel="noopener noreferrer">Minikube<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> - our local development Kubernetes environment. Mac users are free to use Docker for Mac with Kubernetes support, works fine!</li> <li>GitHub - we will store our code here</li> <li>DockerHub - our Docker images will be built and stored here</li> <li>Webhook Relay - will relay public webhooks to our internal Kubernetes environment so we don't have to expose Keel to the public internet</li></ul> <h3 id="set-up-github-repository"><a href="#set-up-github-repository" aria-hidden="true" class="header-anchor">#</a> Set up GitHub repository</h3> <p>First, let's set up our versioning control system. Let's create a local repo of our example app and push it to our GitHub repository.</p> <p>Our example app will be a really really simple one:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;log&quot;</span>
    <span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> version <span class="token operator">=</span> <span class="token string">&quot;v0&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;Welcome to my website! Version %s&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;App is starting, version: %s \n&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8500&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dockerfile and Kubernetes deployment files can be found here: https://github.com/keel-hq/push-workflow-example.</p> <p>Commit your code and push to remote:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token keyword">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;first&quot;</span>
<span class="token function">git</span> push origin master
</code></pre></div><h3 id="configure-webhook-relay-forwarding"><a href="#configure-webhook-relay-forwarding" aria-hidden="true" class="header-anchor">#</a> Configure Webhook Relay forwarding</h3> <p>In this step we will configure Webhook Relay to forward DockerHub webhooks our internal Kubernetes environment. This is especially useful when developing on a local Kubernetes cluster as receiving webhooks from public services can be slightly more complicated.</p> <p>Let's prepare configuration:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># using localhost as a webhookrelayd agent will be running as a sidecar</span>
<span class="token comment"># webhookrelayd sidecar for keel comes with preconfigured bucket name 'dockerhub'</span>
$ relay forward -b dockerhub --no-agent http://localhost:9300/v1/webhooks/dockerhub
Forwarding configuration created: 
https://my.webhookrelay.com/v1/webhooks/b968afa1-b737-4385-bc0f-473dbc2007b4 -<span class="token operator">&gt;</span> http://localhost:9300
In order to start receiving webhooks - start an agent: <span class="token string">'relay forward'</span> 
</code></pre></div><p>We will need that long URL for our next step when configuring DockerHub webhooks.</p> <h3 id="configure-dockerhub-code-repository-webhook"><a href="#configure-dockerhub-code-repository-webhook" aria-hidden="true" class="header-anchor">#</a> Configure DockerHub (code repository + webhook)</h3> <p>Now, we need to tell DockerHub to build a new image on every GitHub push to the master branch. First, go to https://cloud.docker.com, then <code>Repositories</code> and click on <code>Create</code> button. Once you have created the repository, link it to your GitHub account and click on <code>Configure Automated Builds</code>:</p> <p><img src="/img/examples/configure-autobuild.png" alt="configure automated builds"></p> <p>Select your GitHub repository and create a trigger that will:</p> <ul><li>React to changes on a <code>master</code> branch</li> <li>Tag image as <code>latest</code></li></ul> <p>Ensure that <code>autobuild</code> is switched on and click on &quot;Save and Build&quot;. You will get your first image prepared.</p> <p><img src="/img/examples/docker-build-config.png" alt="configure automated builds"></p> <p>Also, we will need to setup DockerHub webhooks to Keel via Webhook Relay. For some reason, that configuration is not available on https://cloud.docker.com and we have to go to https://hub.docker.com:</p> <p><img src="/img/examples/dockerhub-webhook.png" alt="dockerhub webhooks"></p> <h3 id="deploy-keel-and-your-app"><a href="#deploy-keel-and-your-app" aria-hidden="true" class="header-anchor">#</a> Deploy Keel and your app</h3> <p>First, we need to deploy Keel with Webhook Relay sidecar. This is a one-off thing after which when you add more applications to your Kubernetes environment you don't need to repeat this step.</p> <h3 id="credentials-for-webhookrelayd-sidecar"><a href="#credentials-for-webhookrelayd-sidecar" aria-hidden="true" class="header-anchor">#</a> Credentials for webhookrelayd sidecar</h3> <p>Webhook Relay daemon will need authentication details to connect. We can use <code>relay</code> CLI to configure and insert secret into our Kubernetes environment:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># we need to create a namespace first for the secret</span>
$ push-workflow-example git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> kubectl create namespace keel
namespace <span class="token string">&quot;keel&quot;</span> created
<span class="token comment"># by default Keel is deployed in namespace 'keel', therefore we need secret there</span>
$ push-workflow-example git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> relay ingress secret --name webhookrelay-credentials --namespace keel
secret <span class="token string">&quot;webhookrelay-credentials&quot;</span> created
</code></pre></div><h3 id="deploying-keel"><a href="#deploying-keel" aria-hidden="true" class="header-anchor">#</a> Deploying Keel</h3> <p>now, if your cluster has RBAC enabled, use this template (if you are using Minikube then by default it should be enabled):</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl create -f https://raw.githubusercontent.com/keel-hq/keel/master/deployment/deployment-rbac-whr-sidecar.yaml
</code></pre></div><p>and if there's no RBAC in your cluster, use:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl create -f https://raw.githubusercontent.com/keel-hq/keel/master/deployment/deployment-norbac-whr-sidecar.yaml
</code></pre></div><blockquote><p>TIP: Feel free to save deployment manifest locally and add things like Slack or other chat provider notifications, approvals and so on. For the sake of simplicity we are omitting those steps in this tutorial.</p></blockquote> <p>So, when we create it Kubernetes should complain a bit about already existing namespace but that's expected:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl create -f https://raw.githubusercontent.com/keel-hq/keel/master/deployment/deployment-rbac-whr-sidecar.yaml
serviceaccount <span class="token string">&quot;keel&quot;</span> created
clusterrolebinding.rbac.authorization.k8s.io <span class="token string">&quot;keel-clusterrole-binding&quot;</span> created
clusterrole.rbac.authorization.k8s.io <span class="token string">&quot;keel-clusterrole&quot;</span> created
deployment.extensions <span class="token string">&quot;keel&quot;</span> created
Error from server <span class="token punctuation">(</span>AlreadyExists<span class="token punctuation">)</span>: error when creating <span class="token string">&quot;https://raw.githubusercontent.com/keel-hq/keel/master/deployment/deployment-rbac-whr-sidecar.yaml&quot;</span><span class="token keyword">:</span> namespaces <span class="token string">&quot;keel&quot;</span> already exists
$ kubectl get pods -n keel
NAME                   READY     STATUS    RESTARTS   AGE
keel-f8b5959cc-jrgcd   2/2       Running   0          8s
</code></pre></div><h3 id="deploy-your-app"><a href="#deploy-your-app" aria-hidden="true" class="header-anchor">#</a> Deploy your app</h3> <p>Now, we need to create a deployment file of our app:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pushwf  
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;pushwf&quot;</span>
    <span class="token comment"># force policy will ensure that deployment is updated</span>
    <span class="token comment"># even when tag is unchanged (latest remains)</span>
    <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> force
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> pushwf
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> pushwf
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> pushwf
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>     
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                    
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> keelhq/push<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>example<span class="token punctuation">:</span>latest
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always <span class="token comment"># this is required to force pull image     </span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> pushwf
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8500</span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
</code></pre></div><p>Save it as <code>deployment.yaml</code> and create it via kubectl:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl create -f deployment.yaml
</code></pre></div><p>Check whether it's running:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl get pods
NAME                      READY     STATUS    RESTARTS   AGE
pushwf-8476855f97-nw4st   1/1       Running   0          1m
$ kubectl logs pushwf-8476855f97-nw4st
App is starting, version: v0
</code></pre></div><h3 id="push-to-update"><a href="#push-to-update" aria-hidden="true" class="header-anchor">#</a> Push to update</h3> <p>Now, update your Go program's version string to <code>v1</code>:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;log&quot;</span>
    <span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> version <span class="token operator">=</span> <span class="token string">&quot;v1&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;Welcome to my website! Version %s&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;App is starting, version: %s \n&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8500&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Commit and push. In a minute or two (depending on how fast DockerHub can build your image) our app should be updated. Since it's using webhooks, an update should be pretty much instantaneous.</p> <p>If you visit Webhook Relay <code>dockerhub</code> bucket's page, it should show relayed webhook:</p> <p><img src="/img/examples/whr-dockerhub-relayed.png" alt="dockerhub webhooks"></p> <p>Let's check our deployments rollout history:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl rollout <span class="token function">history</span> deployment/pushwf
deployments <span class="token string">&quot;pushwf&quot;</span>
REVISION  CHANGE-CAUSE
1         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
2         keel automated update, version latest -<span class="token operator">&gt;</span> latest
</code></pre></div><p>And logs, just to be sure that our application is running the latest code:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl get pods
NAME                      READY     STATUS    RESTARTS   AGE
pushwf-74c574f9cf-l6lq2   1/1       Running   0          4m
$ kubectl logs pushwf-74c574f9cf-l6lq2
App is starting, version: v1 
</code></pre></div><h3 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h3> <p>While setting up Keel and Webhook Relay can take several of your precious minutes away, it saves an enormous amount of time later. Not only you get an instant update to your applications based on policies but you also ensure that you won't update wrong cluster or environment by mistake. And, of course, you won't even need to use <code>kubectl</code> for your application updates.</p> <p>Once Keel is set up in your cluster in can manage many (all) of your applications. When you add your next app to the cluster, just specify the policy and point DockerHub webhook to the same Webhook Relay endpoint. Keel will filter out relevant deployments based on webhook payload and update them.</p> <p>If you have any questions or find parts of this tutorial incorrect, please raise an issue on Keel's repository <a href="https://github.com/keel-hq/keel/issues" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="example-2-enable-automated-semver-updates"><a href="#example-2-enable-automated-semver-updates" aria-hidden="true" class="header-anchor">#</a> Example 2: Enable automated semver updates</h2> <p>Once in a while (or more often) you need to update your application that's running in a cloud-native fashion inside Kubernetes.</p> <p>Let's see how easy it is to do it with Keel.</p> <p><img src="/img/examples/keel-quick-start.png" alt="Keel Quick Start"></p> <h3 id="install-keel"><a href="#install-keel" aria-hidden="true" class="header-anchor">#</a> Install Keel</h3> <p>Installing Keel is the first step, as long as no update policies are defined in your application deployment files or Helm Charts, Keel will ignore them.
You can choose your preferred installation type (kubectl or Helm) to deploy Keel, more details are available <a href="/docs/#installation">here</a>.</p> <h3 id="specify-update-policy"><a href="#specify-update-policy" aria-hidden="true" class="header-anchor">#</a> Specify update policy</h3> <p>Our example app is 'webhook-demo' which pretty much doesn't do anything except registering incoming webhooks and showing them. Deployment file can be found here: <a href="https://github.com/webhookrelay/webhook-demo/blob/master/hack/deployment.yml" target="_blank" rel="noopener noreferrer">https://github.com/webhookrelay/webhook-demo/blob/master/hack/deployment.yml<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>While traditional deployment manifest would look like this:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wd        
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                    
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>0.0.8
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
</code></pre></div><p>We need to add Keel policy for updates and optional trigger type.</p> <p>These settings have to be specified as labels:</p> <div class="language- extra-class"><pre class="language-text"><code>keel.sh/policy: major
keel.sh/trigger: poll      
</code></pre></div><p>Here:</p> <ul><li><strong>keel.sh/policy: major</strong> specifies that all - major, minor and patch versions should trigger application update.</li> <li><strong>keel.sh/trigger: poll</strong> informs Keel to create an active watcher for the repository that's specified in the deployment file. For private repositories Keel will use existing secrets that Kubernetes uses to pull the image so no additional configuration required. Polling trigger is useful when webhooks or GCR pubsub is not availabe. If you have PUBSUB enabled for your cluster, then you shouldn't use polling trigger.</li></ul> <p>Now, our deployment file looks like this:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>      
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> major
    <span class="token key atrule">keel.sh/trigger</span><span class="token punctuation">:</span> poll      
    <span class="token key atrule">keel.sh/pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 30s&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wd        
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                    
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>0.0.8
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>That's it, we update our deployment with new labels, if you already have your app deployed:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply -f your-app-deployment.yaml
</code></pre></div><p>And then wait for a few minutes till Keel picks up the changes and updates the workload.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/keel-hq/keel.sh/edit/master/examples/README.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.36122d6f.js" defer></script><script src="/assets/js/2.dacee0f1.js" defer></script><script src="/assets/js/8.e82c739a.js" defer></script><script src="/assets/js/3.3918a260.js" defer></script>
  </body>
</html>
