<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guide | Keel</title>
    <meta name="description" content="Keel installation instructions">
    
    <meta name="keywords" content="kubernetes helm manifest install">
    <link rel="preload" href="/assets/css/0.styles.1eab4a7b.css" as="style"><link rel="preload" href="/assets/js/app.36122d6f.js" as="script"><link rel="preload" href="/assets/js/2.dacee0f1.js" as="script"><link rel="preload" href="/assets/js/7.b6f9273d.js" as="script"><link rel="preload" href="/assets/js/3.3918a260.js" as="script"><link rel="prefetch" href="/assets/js/4.00cb3c3f.js"><link rel="prefetch" href="/assets/js/5.59349796.js"><link rel="prefetch" href="/assets/js/6.d94577c7.js"><link rel="prefetch" href="/assets/js/8.e82c739a.js"><link rel="prefetch" href="/assets/js/9.0164cc35.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1eab4a7b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo_small.png" alt="Keel" class="logo"> <span class="site-name can-hide">Keel</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/" class="nav-link router-link-exact-active router-link-active">Guide</a></div><div class="nav-item"><a href="/examples/" class="nav-link">Examples</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">External</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://about.sunstone.dev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Templating
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://webhookrelay.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Webhooks &amp; Tunneling
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/keel-hq/keel" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/docs/" class="nav-link router-link-exact-active router-link-active">Guide</a></div><div class="nav-item"><a href="/examples/" class="nav-link">Examples</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">External</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://about.sunstone.dev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Templating
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://webhookrelay.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Webhooks &amp; Tunneling
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/keel-hq/keel" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/#installation" class="sidebar-link">Installation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/docs/#deploying-with-kubectl" class="sidebar-link">Deploying with kubectl</a></li><li class="sidebar-sub-header"><a href="/docs/#deploying-with-helm" class="sidebar-link">Deploying with Helm</a></li><li class="sidebar-sub-header"><a href="/docs/#environment-variables" class="sidebar-link">Environment variables</a></li><li class="sidebar-sub-header"><a href="/docs/#enabling-admin-dashboard" class="sidebar-link">Enabling admin dashboard</a></li></ul></li><li><a href="/docs/#policies" class="sidebar-link">Policies</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#pre-release-tags" class="sidebar-link">Pre-release tags</a></li></ul></li><li><a href="/docs/#additional-settings" class="sidebar-link">Additional settings</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/#providers" class="sidebar-link">Providers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#kubernetes" class="sidebar-link">Kubernetes</a></li><li class="sidebar-sub-header"><a href="/docs/#kubernetes-example" class="sidebar-link">Kubernetes example</a></li><li class="sidebar-sub-header"><a href="/docs/#statefulset-example" class="sidebar-link">StatefulSet example</a></li><li class="sidebar-sub-header"><a href="/docs/#deployment-polling-example" class="sidebar-link">Deployment polling example</a></li><li class="sidebar-sub-header"><a href="/docs/#daemonset-polling-example" class="sidebar-link">DaemonSet polling example</a></li><li class="sidebar-sub-header"><a href="/docs/#helm" class="sidebar-link">Helm</a></li><li class="sidebar-sub-header"><a href="/docs/#helm-example" class="sidebar-link">Helm example</a></li><li class="sidebar-sub-header"><a href="/docs/#helm-same-tag-force-updates" class="sidebar-link">Helm same tag force updates</a></li></ul></li><li><a href="/docs/#triggers" class="sidebar-link">Triggers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#webhooks" class="sidebar-link">Webhooks</a></li><li class="sidebar-sub-header"><a href="/docs/#dockerhub-webhooks" class="sidebar-link">DockerHub Webhooks</a></li><li class="sidebar-sub-header"><a href="/docs/#quay-webhooks" class="sidebar-link">Quay Webhooks</a></li><li class="sidebar-sub-header"><a href="/docs/#azure-webhooks" class="sidebar-link">Azure Webhooks</a></li><li class="sidebar-sub-header"><a href="/docs/#harbor-webhooks" class="sidebar-link">Harbor webhooks</a></li><li class="sidebar-sub-header"><a href="/docs/#gitlab-webhooks" class="sidebar-link">Gitlab webhooks</a></li><li class="sidebar-sub-header"><a href="/docs/#receiving-webhooks-without-public-endpoint" class="sidebar-link">Receiving webhooks without public endpoint</a></li><li class="sidebar-sub-header"><a href="/docs/#google-cloud-gcr-registry" class="sidebar-link">Google Cloud GCR registry</a></li><li class="sidebar-sub-header"><a href="/docs/#polling" class="sidebar-link">Polling</a></li><li class="sidebar-sub-header"><a href="/docs/#polling-with-aws-ecr" class="sidebar-link">Polling with AWS ECR</a></li></ul></li><li><a href="/docs/#approvals" class="sidebar-link">Approvals</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#enabling-approvals" class="sidebar-link">Enabling approvals</a></li><li class="sidebar-sub-header"><a href="/docs/#configuring-via-kubernetes-deployments" class="sidebar-link">Configuring via Kubernetes deployments</a></li><li class="sidebar-sub-header"><a href="/docs/#configuring-via-helm-charts" class="sidebar-link">Configuring via Helm charts</a></li><li class="sidebar-sub-header"><a href="/docs/#configuring-approvals-with-slack" class="sidebar-link">Configuring approvals with Slack</a></li><li class="sidebar-sub-header"><a href="/docs/#approving-through-slack-example" class="sidebar-link">Approving through Slack example</a></li><li class="sidebar-sub-header"><a href="/docs/#approving-through-hipchat-example" class="sidebar-link">Approving through Hipchat example</a></li><li class="sidebar-sub-header"><a href="/docs/#managing-approvals-through-http-endpoint" class="sidebar-link">Managing approvals through HTTP endpoint</a></li><li class="sidebar-sub-header"><a href="/docs/#listing-pending-approvals-through-http-endpoint" class="sidebar-link">Listing pending approvals through HTTP endpoint</a></li></ul></li><li><a href="/docs/#notifications" class="sidebar-link">Notifications</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/#release-notes-in-notifications" class="sidebar-link">Release notes in notifications</a></li><li class="sidebar-sub-header"><a href="/docs/#webhook-notifications" class="sidebar-link">Webhook notifications</a></li><li class="sidebar-sub-header"><a href="/docs/#slack-notifications" class="sidebar-link">Slack notifications</a></li><li class="sidebar-sub-header"><a href="/docs/#hipchat-notifications" class="sidebar-link">HipChat notifications</a></li><li class="sidebar-sub-header"><a href="/docs/#mattermost-notifications" class="sidebar-link">Mattermost notifications</a></li><li class="sidebar-sub-header"><a href="/docs/#notification-levels" class="sidebar-link">Notification levels</a></li><li class="sidebar-sub-header"><a href="/docs/#overriding-default-channels-per-deployment" class="sidebar-link">Overriding default channels per deployment</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h2 id="introduction"><a href="#introduction" aria-hidden="true" class="header-anchor">#</a> Introduction</h2> <p>What is Keel?</p> <p>Keel aims to be a simple, robust, <strong>background</strong> service that automatically updates Kubernetes workloads so users can focus on important things like writing code, testing and admiring their creation.</p> <p>While <a href="https://cloud.google.com/container-builder/docs/" target="_blank" rel="noopener noreferrer">Container Builder<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://cloud.google.com/container-engine/" target="_blank" rel="noopener noreferrer">Google Container Engine (Kubernetes)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> make a great pair and building images and running your workloads - there is a missing gap: who/what updates deployments when new images are available? maybe it is you:</p> <ol><li>update image tag in <code>deployment.yaml</code></li> <li>run <code>kubectl apply -f deployment.yaml</code></li></ol> <p>These updates can be repetitive, lacking control (user needs access to the cluster) and simply not necessary. This is what Keel solves: pluggable trigger system (webhooks, pubsub, polling) and pluggable provider system (Kubernetes, Helm).</p> <h2 id="installation"><a href="#installation" aria-hidden="true" class="header-anchor">#</a> Installation</h2> <p>Keel doesn't need a database. Keel doesn't need persistent disk. It gets all required information from your cluster. This makes it truly cloud-native and easy to deploy.</p> <h3 id="prerequisites"><a href="#prerequisites" aria-hidden="true" class="header-anchor">#</a> Prerequisites</h3> <ul><li><strong>Kubernetes environment</strong> (easiest way to get Kubernetes up and running is probably <a href="https://cloud.google.com/container-engine/" target="_blank" rel="noopener noreferrer">Google Container Engine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or <a href="https://docs.docker.com/docker-for-mac/kubernetes/" target="_blank" rel="noopener noreferrer">Docker for Mac with Kubernetes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or <a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener noreferrer">Minikube<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li><strong><a href="https://kubernetes.io/docs/user-guide/kubectl-overview/" target="_blank" rel="noopener noreferrer">kubectl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong>: Kubernetes client</li></ul> <blockquote><p>We assume that your kubectl can access Kubernetes environment. If you have multiple environments, you should use <strong>kubectl config use-context [your cluster]</strong> command.</p></blockquote> <h3 id="deploying-with-kubectl"><a href="#deploying-with-kubectl" aria-hidden="true" class="header-anchor">#</a> Deploying with kubectl</h3> <p>You can find sample deployments in https://github.com/keel-hq/keel repository under <a href="https://github.com/keel-hq/keel/tree/master/deployment" target="_blank" rel="noopener noreferrer">deployments directory<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. You can either clone whole repository or just download that file. Edit settings (depending on your environment whether you want to use <a href="https://cloud.google.com/container-registry/" target="_blank" rel="noopener noreferrer">Google Container Registry<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> PUBSUB) or notifications and create it. All configuration is done through environment variables.</p> <p>You can also use <a href="https://about.sunstone.dev" target="_blank" rel="noopener noreferrer">sunstone.dev<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to generate a template with latest semver version or use <code>latest</code> tag:</p> <div class="language- extra-class"><pre class="language-text"><code># To override default latest semver tag, add &amp;tag=x.x.x query argument to the URL below
kubectl apply -f https://sunstone.dev/keel?namespace=keel&amp;username=admin&amp;password=admin&amp;tag=latest
</code></pre></div><p>This command will deploy Keel to <strong>keel</strong> namespace with enabled basic authentication and admin dashboard.</p> <p>To check whether it successfully started - check pods:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl -n keel get pods
</code></pre></div><p>You should see something like this:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl -n keel get pods
NAME                    READY     STATUS    RESTARTS   AGE
keel-2732121452-k7sjc   1/1       Running   0          14s
</code></pre></div><h4 id="uninstalling-keel"><a href="#uninstalling-keel" aria-hidden="true" class="header-anchor">#</a> Uninstalling Keel</h4> <p>To remove Keel from your system, simply delete Keel namespace</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl delete namespace keel
</code></pre></div><h3 id="deploying-with-helm"><a href="#deploying-with-helm" aria-hidden="true" class="header-anchor">#</a> Deploying with Helm</h3> <p>Prerequisites:</p> <ul><li>Helm - <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">https://helm.sh/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Kubernetes</li></ul> <p>You need to add this Chart repo to Helm:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm repo <span class="token function">add</span> keel-charts https://charts.keel.sh 
helm repo update
</code></pre></div><p>Install through Helm (with Helm provider enabled by default):</p> <blockquote><p>Keel must be installed into the same namespace as Tiller, typically <code>kube-system</code></p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>helm upgrade --install keel --namespace=kube-system keel-charts/keel
</code></pre></div><p>If you work mostly with regular Kubernetes manifests, you can install Keel without Helm provider support:</p> <div class="language- extra-class"><pre class="language-text"><code>helm upgrade --install keel --namespace=keel keel-charts/keel --set helmProvider.enabled=&quot;false&quot; 
</code></pre></div><p>You can view all available settings in our <a href="https://github.com/keel-hq/keel/tree/master/chart/keel" target="_blank" rel="noopener noreferrer">chart directory<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Feel free to download values.yaml and edit the settings.</p> <h4 id="uninstalling-the-chart"><a href="#uninstalling-the-chart" aria-hidden="true" class="header-anchor">#</a> Uninstalling the Chart</h4> <p>To uninstall/delete the <code>keel</code> deployment:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm delete keel
</code></pre></div><h3 id="environment-variables"><a href="#environment-variables" aria-hidden="true" class="header-anchor">#</a> Environment variables</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Google Cloud configuration</span>
PROJECT_ID<span class="token operator">=</span><span class="token operator">&lt;</span>project ID<span class="token operator">&gt;</span> - Enable GCR with pub/sub support
PUBSUB - Set to <span class="token string">'1'</span> or <span class="token string">'true'</span> to <span class="token function">enable</span> GCR pubsub

<span class="token comment"># Database location (optional, although if you want stats and audit logs to persist, set it) </span>
XDG_DATA_HOME<span class="token operator">=</span>/data

<span class="token comment"># Authentication</span>
BASIC_AUTH_USER<span class="token operator">=</span><span class="token operator">&lt;</span>admin username<span class="token operator">&gt;</span>
BASIC_AUTH_PASSWORD<span class="token operator">=</span><span class="token operator">&lt;</span>admin password<span class="token operator">&gt;</span>
AUTHENTICATED_WEBHOOKS<span class="token operator">=</span><span class="token operator">&lt;</span>true/false<span class="token operator">&gt;</span>
TOKEN_SECRET<span class="token operator">=</span><span class="token operator">&lt;</span>optional JWT signing secret, auto generated <span class="token keyword">if</span> empty<span class="token operator">&gt;</span>

<span class="token comment">## Helm configuration</span>
HELM_PROVIDER - <span class="token keyword">set</span> to <span class="token string">&quot;1&quot;</span> to <span class="token function">enable</span> Tiller
TILLER_ADDRESS - 

<span class="token comment"># Enable AWS ECR</span>
AWS_ACCESS_KEY_ID<span class="token operator">=</span><span class="token operator">&lt;</span>access key ID<span class="token operator">&gt;</span>
AWS_SECRET_ACCESS_KEY<span class="token operator">=</span><span class="token operator">&lt;</span>access key<span class="token operator">&gt;</span>
AWS_REGION<span class="token operator">=</span><span class="token operator">&lt;</span>region<span class="token operator">&gt;</span>

<span class="token comment"># Enable outgoing webhooks</span>
WEBHOOK_ENDPOINT<span class="token operator">=</span><span class="token operator">&lt;</span>https://your-endpoint<span class="token operator">&gt;</span>

<span class="token comment"># Enable mattermost endpoint</span>
MATTERMOST_ENDPOINT<span class="token operator">=</span><span class="token operator">&lt;</span>mattermost incoming webhook endpoint<span class="token operator">&gt;</span>

<span class="token comment"># Slack configuration</span>
SLACK_TOKEN

SLACK_CHANNELS<span class="token operator">=</span><span class="token operator">&lt;</span>slack channel, defaults to <span class="token string">&quot;general&quot;</span><span class="token operator">&gt;</span>
SLACK_APPROVALS_CHANNEL<span class="token operator">=</span><span class="token operator">&lt;</span>slack approvals channel, defaults to <span class="token string">&quot;general&quot;</span><span class="token operator">&gt;</span>
SLACK_BOT_NAME<span class="token operator">=</span><span class="token operator">&lt;</span>slack bot name, defaults to <span class="token string">&quot;keel&quot;</span><span class="token operator">&gt;</span>

<span class="token comment"># Enable hipchat approvials and notification</span>
HIPCHAT_TOKEN
HIPCHAT_CHANNELS
HIPCHAT_APPROVALS_CHANNEL
HIPCHAT_APPROVALS_BOT_NAME
HIPCHAT_APPROVALS_USER_NAME
HIPCHAT_APPROVALS_PASSWORT

<span class="token comment"># System wide notification level (webhooks, chat)</span>
NOTIFICATION_LEVEL<span class="token operator">=</span><span class="token string">&quot;info&quot;</span>
<span class="token comment"># Enable insecure registries</span>
INSECURE_REGISTRY<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
</code></pre></div><h3 id="enabling-admin-dashboard"><a href="#enabling-admin-dashboard" aria-hidden="true" class="header-anchor">#</a> Enabling admin dashboard</h3> <div class="warning custom-block"><p>Follow <a href="/docs/#enabling-admin-dashboard">these instruction on how to enable admin UI</a>. Admin dashboard hasn't been fully released yet, it's only available through the <code>latest</code> tag or if you compile Keel from the <code>master</code> branch.</p></div> <p>To enable admin dashboard, you will need to:</p> <ol><li>Set BASIC_AUTH_USER and BASIC_AUTH_PASSWORD environment variables</li> <li>Create a service so you can access it. Keel UI and API are accessible on port 9300 by default.</li></ol> <p>To access Keel admin dashboard without configuring public IP, you can use <a href="https://webhookrelay.com" target="_blank" rel="noopener noreferrer">webhookrelay.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> tunnels. There's a default template to generate Keel configuration with tunnels enabled. First get a <a href="https://my.webhookrelay.com/tunnels" target="_blank" rel="noopener noreferrer">token<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> &amp; <a href="https://my.webhookrelay.com/tunnels" target="_blank" rel="noopener noreferrer">tunnel<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, then deploy through <a href="https://about.sunstone.dev" target="_blank" rel="noopener noreferrer">sunstone.dev<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply -f https://sunstone.dev/keel?namespace<span class="token operator">=</span>default<span class="token operator">&amp;</span>username<span class="token operator">=</span>admin<span class="token operator">&amp;</span>password<span class="token operator">=</span>admin<span class="token operator">&amp;</span>relay_key<span class="token operator">=</span>TOKEN_KEY<span class="token operator">&amp;</span>relay_secret<span class="token operator">=</span>TOKEN_SECRET<span class="token operator">&amp;</span>relay_tunnel<span class="token operator">=</span>TUNNEL_NAME<span class="token operator">&amp;</span>tag<span class="token operator">=</span>latest
</code></pre></div><p>Then, access it through the tunnel address such as your-subdomain.webrelay.io:</p> <p><img src="/img/keel_ui.png" alt="Keel Web UI"></p> <p>Admin dashboard allows you to:</p> <ul><li>Enable/disable automated updates</li> <li>Set/change policies</li> <li>Enable/disable polling</li> <li>View all tracked images</li> <li>See audit logs (updates, approvals)</li> <li>Last 30 days statistics</li></ul> <h2 id="policies"><a href="#policies" aria-hidden="true" class="header-anchor">#</a> Policies</h2> <p>Use policies to define when you want your application to be updated. Providers can have different mechanisms of getting configuration for your application, but policies are consistent across all of them. Following <a href="http://semver.org/" target="_blank" rel="noopener noreferrer">semver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
best practices allows you to safely automate application updates.</p> <p>Available policies:</p> <ul><li><strong>all</strong>: update whenever there is a version bump or a new prerelease created (ie: <code>1.0.0</code> -&gt; <code>1.0.1-rc1</code>)</li> <li><strong>major</strong>: update major &amp; minor &amp; patch versions</li> <li><strong>minor</strong>: update only minor &amp; patch versions (ignores major)</li> <li><strong>patch</strong>: update only patch versions (ignores minor and major versions)</li> <li><strong>force</strong>: force update even if tag is not semver, ie: <code>latest</code>, optional label: <strong>keel.sh/match-tag=true</strong> which will enforce that only the same tag will trigger force update.</li> <li><strong>glob</strong>: use wildcards to match versions, example:</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> <span class="token string">&quot;glob:build-*&quot;</span>  <span class="token comment"># &lt;- build-1, build-2, build-foo will match this. </span>
</code></pre></div><ul><li><strong>regexp</strong>: use regular expressions to match versions, example:</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> <span class="token string">&quot;regexp:^([a-zA-Z]+)$&quot;</span>
</code></pre></div><h3 id="pre-release-tags"><a href="#pre-release-tags" aria-hidden="true" class="header-anchor">#</a> Pre-release tags</h3> <p>According to semver (http://semver.org/) spec, version tags can have additional metadata such as <code>1.0.0-dev</code>, <code>1.0.0-prod</code>, etc. Keel deals with semver tags by only allowing updates with the same version metadata.</p> <p>Example:</p> <ul><li>tag: <code>0.5.0-dev</code> policy: <code>minor</code> will only be updated by <code>0.6.0-dev</code> and not <code>0.5.0-prod</code></li> <li>tag <code>0.5.0</code> policy: <code>minor</code> will not be updated by <code>0.6.0-rc1</code></li></ul> <p>This way you can easily separate different environments and update them independently.</p> <h2 id="additional-settings"><a href="#additional-settings" aria-hidden="true" class="header-anchor">#</a> Additional settings</h2> <p>Keel tries to mostly rely on your resource configuration files, such as deployment, daemonset, statefulset labels &amp; annotations. Here is an example with all available options:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> minor     <span class="token comment"># update policy (available: patch, minor, major, all, force)</span>
      <span class="token key atrule">keel.sh/trigger</span><span class="token punctuation">:</span> poll     <span class="token comment"># enable active repository checking (webhooks and GCR would still work)</span>
      <span class="token key atrule">keel.sh/approvals</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>    <span class="token comment"># required approvals to update</span>
      <span class="token key atrule">keel.sh/match-tag</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span> <span class="token comment"># only makes a difference when used with 'force' policy, will only update if tag matches :dev-&gt;:dev, :prod-&gt;:prod </span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 1m&quot;</span>
      <span class="token key atrule">keel.sh/notify</span><span class="token punctuation">:</span> chan1<span class="token punctuation">,</span>chan2  <span class="token comment"># chat channels to sent notification to</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
        <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>master
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
</code></pre></div><h2 id="providers"><a href="#providers" aria-hidden="true" class="header-anchor">#</a> Providers</h2> <p>Providers are direct integrations into schedulers or other tools (ie: Helm). Providers are handling events created by triggers. Each provider can handle events in different ways, for example Kubernetes provider identifies impacted deployments and starts rolling update while Helm provider communicates with Tiller, identifies releases by Chart and then starts update.</p> <p>Available providers:</p> <ul><li>Kubernetes (supports Deployments, DaemonSets, StatefulSets)</li> <li>Helm</li></ul> <p>While the goal is often the same, different providers can choose different update strategies.</p> <h3 id="kubernetes"><a href="#kubernetes" aria-hidden="true" class="header-anchor">#</a> Kubernetes</h3> <p>Kubernetes provider was the first, simplest provider added to Keel. Policies and trigger configuration for each application deployment is done through labels.</p> <p>Policies are specified through special label:</p> <div class="language- extra-class"><pre class="language-text"><code>keel.sh/policy=all
</code></pre></div><p>A policy to update only minor releases:</p> <div class="language- extra-class"><pre class="language-text"><code>keel.sh/policy=minor
</code></pre></div><h3 id="kubernetes-example"><a href="#kubernetes-example" aria-hidden="true" class="header-anchor">#</a> Kubernetes example</h3> <p>Here is an example application <code>deployment.yaml</code> where we instruct Keel to update container image whenever there is a new version:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> all
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wd        

    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                    
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>0.0.2
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true      </span>
</code></pre></div><p>If Keel gets an event that <code>karolisr/webhook-demo:0.0.3</code> is available - it will update deployment and therefore start a rolling update.</p> <h3 id="statefulset-example"><a href="#statefulset-example" aria-hidden="true" class="header-anchor">#</a> StatefulSet example</h3> <p>StatefulSets can also be updated by Kubernetes once image has changed:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> major    
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wd        
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                    
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>0.0.8
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10              </span>
</code></pre></div><h3 id="deployment-polling-example"><a href="#deployment-polling-example" aria-hidden="true" class="header-anchor">#</a> Deployment polling example</h3> <p>While the deployment above works perfect for both webhook and Google Cloud Pubsub triggers sometimes you can't control these events and the only available solution is to check registry yourself. This is where polling trigger comes to the rescue.</p> <div class="warning custom-block"><p><strong>Note</strong>: when image with non-semver style tag is supplied (ie: <code>latest</code>) Keel will monitor SHA digest. If tag is semver - it will track and notify providers when new versions are available.</p></div> <p>Add labels:</p> <div class="language- extra-class"><pre class="language-text"><code>keel.sh/policy=force # add this to enable updates of non-semver tags
keel.sh/trigger=poll
</code></pre></div><p>To specify custom polling schedule, use <em>keel.sh/pollSchedule: &quot;@every 10m&quot;</em> annotation. A duration string is a possibly signed sequence of decimal numbers, each with optional fraction and a unit suffix, such as &quot;300ms&quot;, &quot;1.5h&quot; or &quot;2h45m&quot;. Valid time units are &quot;ns&quot;, &quot;us&quot; (or &quot;µs&quot;), &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot;.</p> <div class="tip custom-block"><p><strong>Note</strong> that even if polling trigger is set - webhooks or pubsub events can still trigger updates</p></div> <p>Example deployment file for polling:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> force
      <span class="token key atrule">keel.sh/trigger</span><span class="token punctuation">:</span> poll      
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 10m&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wd        

    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>latest <span class="token comment"># this would start repository digest checks</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true      </span>
</code></pre></div><h3 id="daemonset-polling-example"><a href="#daemonset-polling-example" aria-hidden="true" class="header-anchor">#</a> DaemonSet polling example</h3> <p>Since DaemonSets have labels and annotations, their configuration is not different from Deployment or StatefulSet configuration:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> minor
      <span class="token key atrule">keel.sh/trigger</span><span class="token punctuation">:</span> poll            
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 1m&quot;</span>          
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
        <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>0.0.8
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090       </span>
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8090</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true         </span>
</code></pre></div><h3 id="helm"><a href="#helm" aria-hidden="true" class="header-anchor">#</a> Helm</h3> <p>Helm helps you manage Kubernetes applications — Helm Charts helps you define, install, and upgrade even the most complex Kubernetes application. More information can be found on project's website <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">https://helm.sh/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Keel works directly with Tiller (a daemon that is used by Helm CLI) to manage release upgrades when new images are available.</p> <h3 id="helm-example"><a href="#helm-example" aria-hidden="true" class="header-anchor">#</a> Helm example</h3> <p>Keel is configured through your chart's <code>values.yaml</code> file.</p> <p>Here is an example application <code>values.yaml</code> file where we instruct Keel to track and update specific values whenever there is a new version:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">image</span><span class="token punctuation">:</span>
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">&quot;0.0.8&quot;</span>
  <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookdemo
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">externalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>
  <span class="token key atrule">internalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>

<span class="token key atrule">keel</span><span class="token punctuation">:</span>
  <span class="token comment"># keel policy (all/major/minor/patch/force)</span>
  <span class="token key atrule">policy</span><span class="token punctuation">:</span> all
  <span class="token comment"># images to track and update</span>
  <span class="token key atrule">images</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">repository</span><span class="token punctuation">:</span> image.repository <span class="token comment"># [1]</span>
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> image.tag  <span class="token comment"># [2]</span>
</code></pre></div><p>If Keel gets an event that <code>karolisr/webhook-demo:0.0.9</code> is available - it will upgrade release values so Helm can start updating your application.</p> <ul><li>[1]  resolves during runtime image.repository -&gt; karolisr/webhook-demo</li> <li>[2]  resolves during runtime image.tag -&gt; 0.0.8</li></ul> <h3 id="helm-same-tag-force-updates"><a href="#helm-same-tag-force-updates" aria-hidden="true" class="header-anchor">#</a> Helm same tag force updates</h3> <p>If you are not using versioning and pushing to the same tag, you should modify your template to change it on each update.</p> <p>Current consensus on a best way to &quot;force&quot; update Helm releases is by modifying your pod spec template by adding:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">date/deploy-date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> now <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>annotation. This way Helm's Tiller will always detect a change in your template and Kubernetes will start a rolling update on the resource.</p> <h4 id="helm-configuration-polling-example"><a href="#helm-configuration-polling-example" aria-hidden="true" class="header-anchor">#</a> Helm configuration polling example</h4> <p>This example demonstrates Keel configuration for polling.</p> <div class="tip custom-block"><p><strong>Note</strong> that even if polling trigger is set - webhooks or pubsub events can still trigger updates</p></div> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">image</span><span class="token punctuation">:</span>
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">&quot;0.0.8&quot;</span>
  <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookdemo
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">externalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>
  <span class="token key atrule">internalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>

<span class="token key atrule">keel</span><span class="token punctuation">:</span>
  <span class="token comment"># keel policy (all/major/minor/patch/force)</span>
  <span class="token key atrule">policy</span><span class="token punctuation">:</span> all
  <span class="token comment"># trigger type, defaults to events such as pubsub, webhooks</span>
  <span class="token key atrule">trigger</span><span class="token punctuation">:</span> poll
  <span class="token comment"># polling schedule</span>
  <span class="token key atrule">pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 2m&quot;</span>
  <span class="token comment"># images to track and update</span>
  <span class="token key atrule">images</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">repository</span><span class="token punctuation">:</span> image.repository <span class="token comment"># [1]</span>
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> image.tag  <span class="token comment"># [2]</span>
</code></pre></div><h4 id="helm-polling-private-registry"><a href="#helm-polling-private-registry" aria-hidden="true" class="header-anchor">#</a> Helm polling private registry</h4> <p>If you are polling a private repository, you can set secret name for an image to use for authentication:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">image</span><span class="token punctuation">:</span>
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">&quot;0.0.8&quot;</span>
  <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookdemo
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">externalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>
  <span class="token key atrule">internalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>

<span class="token key atrule">keel</span><span class="token punctuation">:</span>
  <span class="token comment"># keel policy (all/major/minor/patch/force)</span>
  <span class="token key atrule">policy</span><span class="token punctuation">:</span> all
  <span class="token comment"># trigger type, defaults to events such as pubsub, webhooks</span>
  <span class="token key atrule">trigger</span><span class="token punctuation">:</span> poll
  <span class="token comment"># polling schedule</span>
  <span class="token key atrule">pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 2m&quot;</span>
  <span class="token comment"># images to track and update</span>
  <span class="token key atrule">images</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">repository</span><span class="token punctuation">:</span> image.repository
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> image.tag  
      <span class="token key atrule">imagePullSecret</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>name
</code></pre></div><h2 id="triggers"><a href="#triggers" aria-hidden="true" class="header-anchor">#</a> Triggers</h2> <p>Triggers are entry points into the Keel. Their task is to collect information regarding updated images and send events to providers.</p> <p>Available triggers:</p> <ul><li>Webhooks
<ul><li>Native Webhooks</li> <li>DockerHub Webhooks</li> <li>Quay Webhooks</li> <li>Harbor webhooks</li> <li>Gitlab webhooks</li> <li>Receiving webhooks without public endpoint</li></ul></li> <li>Google Cloud GCR registry</li> <li>Polling</li></ul> <h3 id="webhooks"><a href="#webhooks" aria-hidden="true" class="header-anchor">#</a> Webhooks</h3> <p>Webhooks are &quot;user-defined HTTP callbacks&quot;. They are usually triggered by some event, such as pushing image to a registry. Native webhooks (simplified version) are accepted at <code>/v1/webhooks/native</code> endpoint with a payload that has <strong>name</strong> and <strong>tag</strong> fields:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gcr.io/v2-namespace/hello-world&quot;</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.1.1&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Keel by default runs HTTP server on port 9300. Create a service and either expose it to the internet or use <a href="https://webhookrelay.com" target="_blank" rel="noopener noreferrer">https://webhookrelay.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to receive webhooks.</p></blockquote> <h3 id="dockerhub-webhooks"><a href="#dockerhub-webhooks" aria-hidden="true" class="header-anchor">#</a> DockerHub Webhooks</h3> <p>DockerHub uses webhooks to inform 3rd party systems about repository related events such as pushed image.</p> <p>https://docs.docker.com/docker-hub/webhooks - go to your repository on
<code>https://hub.docker.com/r/your-namespace/your-repository/~/settings/webhooks/</code> and point webhooks
to <code>/v1/webhooks/dockerhub</code> endpoint. Any number of repositories
can send events to this endpoint.</p> <h3 id="quay-webhooks"><a href="#quay-webhooks" aria-hidden="true" class="header-anchor">#</a> Quay Webhooks</h3> <p>Documentation on how to setup Quay webhooks for <strong>Repository Push</strong> events is available here: <a href="https://docs.quay.io/guides/notifications.html" target="_blank" rel="noopener noreferrer">https://docs.quay.io/guides/notifications.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. These webhooks should be delivered to <code>/v1/webhooks/quay</code> endpoint. Any number of repositories
can send events to this endpoint.</p> <h3 id="azure-webhooks"><a href="#azure-webhooks" aria-hidden="true" class="header-anchor">#</a> Azure Webhooks</h3> <p>Documentation on how to setup Azure webhooks is available here: https://docs.microsoft.com/en-us/azure/container-registry/container-registry-webhook. Azure webhooks should be delivered to <code>/v1/webhooks/azure</code> endpoint.</p> <h3 id="harbor-webhooks"><a href="#harbor-webhooks" aria-hidden="true" class="header-anchor">#</a> Harbor webhooks</h3> <p>Keel supports https://github.com/goharbor/harbor webhooks. Harbor webhooks should be delivered to <code>/v1/webhooks/registry</code> endpoint. Harbor webhooks are based on <a href="https://docs.docker.com/registry/notifications/" target="_blank" rel="noopener noreferrer">Docker registry notifications<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="gitlab-webhooks"><a href="#gitlab-webhooks" aria-hidden="true" class="header-anchor">#</a> Gitlab webhooks</h3> <p>Keel supports Gitlab registry notifications also known as webhooks (https://docs.gitlab.com/ee/administration/container_registry.html#configure-container-registry-notifications). Gitlab webhooks should be delivered to <code>/v1/webhooks/registry</code> endpoint. Gitlab webhooks are based on <a href="https://docs.docker.com/registry/notifications/" target="_blank" rel="noopener noreferrer">Docker registry notifications<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="receiving-webhooks-without-public-endpoint"><a href="#receiving-webhooks-without-public-endpoint" aria-hidden="true" class="header-anchor">#</a> Receiving webhooks without public endpoint</h3> <p>If you don't want to expose your Keel service - recommended solution is <a href="https://webhookrelay.com/" target="_blank" rel="noopener noreferrer">https://webhookrelay.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which can deliver webhooks to your internal Keel service through a sidecar container.</p> <p>Example sidecar container configuration for your <code>deployments.yaml</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> webhookrelay/webhookrelayd<span class="token punctuation">:</span>latest
          <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookrelayd          
          <span class="token key atrule">env</span><span class="token punctuation">:</span>                         
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KEY
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookrelay<span class="token punctuation">-</span>credentials
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> key                
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SECRET
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookrelay<span class="token punctuation">-</span>credentials
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> secret
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> BUCKET
              <span class="token key atrule">value</span><span class="token punctuation">:</span> dockerhub      
</code></pre></div><h3 id="google-cloud-gcr-registry"><a href="#google-cloud-gcr-registry" aria-hidden="true" class="header-anchor">#</a> Google Cloud GCR registry</h3> <p>If you are using Google Container Engine with Container Registry - search no more, pubsub trigger is for you.</p> <p class="tip">You will need to create a Google Service Account to use PubSub functionality.</p> <p>Since Keel requires access for the pubsub in GCE Kubernetes to work - your cluster node pools need to have permissions. If you are creating a new cluster - just enable pubsub from the start. If you have an existing cluster - currently the only way is to create a new node-pool through the gcloud CLI (more info in the <a href="https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create?hl=en_US&amp;_ga=1.2114551.650086469.1487625651" target="_blank" rel="noopener noreferrer">docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>):</p> <h4 id="create-a-node-pool-with-enabled-pubsub-scope"><a href="#create-a-node-pool-with-enabled-pubsub-scope" aria-hidden="true" class="header-anchor">#</a> Create a node pool with enabled pubsub scope</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>gcloud container node-pools create new-pool --cluster CLUSTER_NAME --scopes https://www.googleapis.com/auth/pubsub
</code></pre></div><h4 id="create-a-service-account"><a href="#create-a-service-account" aria-hidden="true" class="header-anchor">#</a> Create a service account</h4> <p>Detailed tutorial on creating and configuring service account to access Google services is available here: https://cloud.google.com/kubernetes-engine/docs/tutorials/authenticating-to-cloud-platform.</p> <p>High level steps:</p> <ol><li>Create a service account through Google cloud console with a role: <code>roles/pubsub.editor</code> (Keel needs to create topics as well for GCR registries).</li> <li>Furnish a new private key and choose key type as JSON.</li> <li>Import credentials as a secret:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl create -n <span class="token operator">&lt;</span>KEEL NAMESPACE<span class="token operator">&gt;</span> secret generic pubsub-key --from-file<span class="token operator">=</span>key.json<span class="token operator">=</span><span class="token operator">&lt;</span>PATH-TO-KEY-FILE<span class="token operator">&gt;</span>.json
</code></pre></div><ol start="4"><li>Configure the application with the Secret</li></ol> <h4 id="update-keel-s-environment-variables"><a href="#update-keel-s-environment-variables" aria-hidden="true" class="header-anchor">#</a> Update Keel's environment variables</h4> <p>Make sure that in the deployment.yaml you have set environment variables <strong>PUBSUB=1</strong>,  <strong>PROJECT_ID=your-project-id</strong> and <strong>GOOGLE_APPLICATION_CREDENTIALS</strong> to your secrets yaml.</p> <h3 id="polling"><a href="#polling" aria-hidden="true" class="header-anchor">#</a> Polling</h3> <p>Since only the owners of docker registries can control webhooks - it's often convenient to use
polling. Be aware that registries can be rate limited so it's a good practice to set up reasonable polling intervals.
While configuration for each provider can be slightly different - each provider has to accept several polling parameters:</p> <ul><li>Explicitly enable polling trigger</li> <li>Supply polling schedule (defaults to 1 minute intervals)</li></ul> <h4 id="cron-expression-format"><a href="#cron-expression-format" aria-hidden="true" class="header-anchor">#</a> Cron expression format</h4> <p>Custom polling schedule can be specified as cron format or through predefined schedules (recommended solution).</p> <p>Available schedules:</p> <table><thead><tr><th>Entry</th> <th>Description</th> <th>Equivalent To</th></tr></thead> <tbody><tr><td>@yearly (or @annually)</td> <td>Run once a year, midnight, Jan. 1st</td> <td><code>0 0 0 1 1 *</code></td></tr> <tr><td>@monthly</td> <td>Run once a month, midnight, first of month</td> <td><code>0 0 0 1 * *</code></td></tr> <tr><td>@weekly</td> <td>Run once a week, midnight on Sunday</td> <td><code>0 0 0 * * 0</code></td></tr> <tr><td>@daily (or @midnight)</td> <td>Run once a day, midnight</td> <td><code>0 0 0 * * *</code></td></tr> <tr><td>@hourly</td> <td>Run once an hour, beginning of hour</td> <td><code>0 0 * * * *</code></td></tr></tbody></table> <p>Example deployment file with enabled polling:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> minor     <span class="token comment"># update policy (available: patch, minor, major, all, force)</span>
      <span class="token key atrule">keel.sh/trigger</span><span class="token punctuation">:</span> poll     <span class="token comment"># enable active repository checking (webhooks and GCR would still work)</span>
      <span class="token key atrule">keel.sh/pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 1m&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wd<span class="token punctuation">-</span>ds
        <span class="token key atrule">image</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>master
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always            
        <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/webhook-demo&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>
</code></pre></div><h3 id="polling-with-aws-ecr"><a href="#polling-with-aws-ecr" aria-hidden="true" class="header-anchor">#</a> Polling with AWS ECR</h3> <p>If you are using polling trigger with Amazon ECR registry, Keel deployment requires several environment variables:</p> <div class="language- extra-class"><pre class="language-text"><code>AWS_ACCESS_KEY_ID=AKIA.........
AWS_SECRET_ACCESS_KEY=3v..............
AWS_REGION=us-east-2 # &lt;- where your registry is
</code></pre></div><p>Documentation on setting up credentials can be found here: https://docs.aws.amazon.com/amazonswf/latest/awsrbflowguide/set-up-creds.html.</p> <h4 id="intervals"><a href="#intervals" aria-hidden="true" class="header-anchor">#</a> Intervals</h4> <p>You may also schedule a job to execute at fixed intervals. This is supported by formatting the cron spec like this:</p> <p><code>@every &lt;duration&gt;</code></p> <p>where <em>duration</em> is a string accepted by <a href="http://golang.org/pkg/time/#ParseDuration" target="_blank" rel="noopener noreferrer">time.ParseDuration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>For example, <em>@every 1h30m10s</em> would indicate a schedule that activates every 1 hour, 30 minutes, 10 seconds.</p> <blockquote><p><strong>Tip</strong>: If you want to disable polling support for your Keel installation - set environment variable
<strong>POLL=0</strong>.</p></blockquote> <h2 id="approvals"><a href="#approvals" aria-hidden="true" class="header-anchor">#</a> Approvals</h2> <p>Users can specify on deployments and Helm charts how many approvals do they have to collect before a resource gets updated. Main features:</p> <ul><li><strong>non-blocking</strong> - multiple deployments/helm releases can be queued for approvals, the ones without specified approvals will be auto updated.</li> <li><strong>extensible</strong> - current implementation focuses on Slack but additional approval collection mechanisms are trivial to implement.</li> <li><strong>out of the box Slack integration</strong> - the only needed Keel configuration is Slack auth token, Keel will start requesting approvals and users will be able to approve.</li> <li><strong>stateful</strong> - uses SQLite for persistence so even after updating itself (restarting) it will retain existing info.</li> <li><strong>self cleaning</strong> - expired approvals will be removed after deadline is exceeded.</li></ul> <h3 id="enabling-approvals"><a href="#enabling-approvals" aria-hidden="true" class="header-anchor">#</a> Enabling approvals</h3> <p>Approvals are enabled by default but currently there is only one way to approve/reject updates:
Slack - commands like:</p> <ul><li><code>keel get approvals</code> - get all pending/approved/rejected approvals</li> <li><code>keel approve &lt;identifier&gt;</code> - approve specified request.</li> <li><code>keel reject &lt;identifier&gt;</code> - reject specified request.</li></ul> <p>Make sure you have set <code>export SLACK_TOKEN=&lt;your slack token here&gt;</code> environment variable for Keel deployment.</p> <p>If you wish to specify a special channel for approval requests, supply <code>SLACK_APPROVALS_CHANNEL=&lt;approvals channel name&gt;</code> environment variable and then invite Keel bot to that channel.</p> <h3 id="configuring-via-kubernetes-deployments"><a href="#configuring-via-kubernetes-deployments" aria-hidden="true" class="header-anchor">#</a> Configuring via Kubernetes deployments</h3> <p>The only required configuration for Kubernetes deployment to enable approvals is to add <code>keel.sh/approvals: &quot;1&quot;</code> with a number (string! as the underlying type is map[string]string) of required approvals.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> all
      <span class="token key atrule">keel.sh/trigger</span><span class="token punctuation">:</span> poll      
      <span class="token key atrule">keel.sh/approvals</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
</code></pre></div><h3 id="configuring-via-helm-charts"><a href="#configuring-via-helm-charts" aria-hidden="true" class="header-anchor">#</a> Configuring via Helm charts</h3> <p>To enable approvals for a Helm chart update Keel config section in <code>values.yaml</code> with a required number of approvals:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">image</span><span class="token punctuation">:</span>
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> karolisr/webhook<span class="token punctuation">-</span>demo
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">&quot;0.0.13&quot;</span>
  <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhookdemo
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">externalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>
  <span class="token key atrule">internalPort</span><span class="token punctuation">:</span> <span class="token number">8090</span>

<span class="token key atrule">keel</span><span class="token punctuation">:</span>
  <span class="token comment"># keel policy (all/major/minor/patch/force)</span>
  <span class="token key atrule">policy</span><span class="token punctuation">:</span> all
  <span class="token comment"># trigger type, defaults to events such as pubsub, webhooks</span>
  <span class="token key atrule">trigger</span><span class="token punctuation">:</span> poll
  <span class="token comment"># polling schedule</span>
  <span class="token key atrule">pollSchedule</span><span class="token punctuation">:</span> <span class="token string">&quot;@every 1m&quot;</span>
  <span class="token comment"># approvals required to proceed with an update</span>
  <span class="token key atrule">approvals</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token comment"># approvals deadline in hours</span>
  <span class="token key atrule">approvalDeadline</span><span class="token punctuation">:</span> <span class="token number">24 </span>
  <span class="token comment"># images to track and update</span>
  <span class="token key atrule">images</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">repository</span><span class="token punctuation">:</span> image.repository
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> image.tag
</code></pre></div><h3 id="configuring-approvals-with-slack"><a href="#configuring-approvals-with-slack" aria-hidden="true" class="header-anchor">#</a> Configuring approvals with Slack</h3> <p>Slack configuration can be sometimes quite confusing. If something has changed, please create an issue.</p> <h4 id="step-1-adding-bot-app-and-getting-token"><a href="#step-1-adding-bot-app-and-getting-token" aria-hidden="true" class="header-anchor">#</a> Step 1: adding bot app and getting token</h4> <p>Go to your Slack apps page: https://[your-slack-community].slack.com/apps/A0F7YS25R-bots?page=1</p> <p><img src="/img/docs/slack-bots.png" alt="Slack bots"></p> <p>Set name to Keel</p> <p><img src="/img/docs/slack-bot-name.png" alt="Slack bot name"></p> <h4 id="step-2-supplying-token-to-keel"><a href="#step-2-supplying-token-to-keel" aria-hidden="true" class="header-anchor">#</a> Step 2: supplying token to Keel</h4> <p>Use provided token as an environment variable in Keel's deployment:</p> <p><code>SLACK_TOKEN=token</code></p> <h3 id="approving-through-slack-example"><a href="#approving-through-slack-example" aria-hidden="true" class="header-anchor">#</a> Approving through Slack example</h3> <p>Keel will send notifications to your Slack group about pending approvals. Approval process is as simple as replying to Keel:</p> <ul><li>Approve: <code>keel approve default/whr:0.4.12</code></li> <li>Reject it: <code>keel reject default/whr:0.4.12</code></li></ul> <p>Example conversation:</p> <p><img src="/img/docs/approvals.png" alt="Approvals"></p> <h3 id="approving-through-hipchat-example"><a href="#approving-through-hipchat-example" aria-hidden="true" class="header-anchor">#</a> Approving through Hipchat example</h3> <p>Coming soon...</p> <h3 id="managing-approvals-through-http-endpoint"><a href="#managing-approvals-through-http-endpoint" aria-hidden="true" class="header-anchor">#</a> Managing approvals through HTTP endpoint</h3> <p>For third party integrations it can be useful to approve/reject/delete via HTTP endpoint. You can send an approval request via HTTP endpoint:</p> <p><strong>Method</strong>: POST
<strong>Endpoint</strong>: <code>/v1/approvals</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;default/myimage:1.5.5&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- identifier for the approval request</span>
  <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;approve&quot;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- approve/reject/delete, defaults to &quot;approve&quot;</span>
  <span class="token property">&quot;voter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;john&quot;</span><span class="token punctuation">,</span>  
<span class="token punctuation">}</span>
</code></pre></div><h3 id="listing-pending-approvals-through-http-endpoint"><a href="#listing-pending-approvals-through-http-endpoint" aria-hidden="true" class="header-anchor">#</a> Listing pending approvals through HTTP endpoint</h3> <p>You can also view pending/rejected/approved update request on <code>/v1/approvals</code> Keel endpoint (make sure you have service exported). Example response:</p> <p><strong>Method</strong>: GET
<strong>Endpoint</strong>: <code>/v1/approvals</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
	<span class="token punctuation">{</span>
		<span class="token property">&quot;provider&quot;</span><span class="token operator">:</span> <span class="token string">&quot;helm&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;default/wd:0.0.15&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;repository&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.docker.io/karolisr/webhook-demo&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.15&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;digest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">&quot;createdAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0001-01-01T00:00:00Z&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;triggerName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;poll&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;New image is available for release default/wd (0.0.13 -&gt; 0.0.15).&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;currentVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.13&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;newVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.15&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;votesRequired&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token property">&quot;deadline&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-09-26T09:14:54.979211563+01:00&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;createdAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-09-26T09:14:54.980936804+01:00&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;updatedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-09-26T09:14:54.980936824+01:00&quot;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="notifications"><a href="#notifications" aria-hidden="true" class="header-anchor">#</a> Notifications</h2> <p>Keel can send notifications on successful or failed deployment updates.  There are several types of notifications - trusted webhooks or Slack, Hipchat messages.</p> <p>Notification types:</p> <p><strong>Pre-deployment update</strong> - fired before doing update. Can be used to drain running tasks.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;preparing to update deployment&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;Preparing to update deployment &lt;your deployment namespace/name&gt; (gcr.io/webhookrelay/webhook-demo:0.0.10)&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;createdAt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2017-07-23T23:51:46.478440258+01:00&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;preparing deployment update&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;LevelDebug&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Successful deployment update</strong> - fired after successful update.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;deployment update&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;Successfully updated deployment &lt;your deployment namespace/name&gt; (gcr.io/webhookrelay/webhook-demo:0.0.10)&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;createdAt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2017-07-23T23:51:46.478440258+01:00&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;deployment update&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;LevelSuccess&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Failed deployment update</strong> - fired after failed event.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;deployment update&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;Deployment &lt;your deployment namespace/name&gt; (gcr.io/webhookrelay/webhook-demo:0.0.10) update failed, error: &lt;error here&gt; &quot;</span><span class="token punctuation">,</span> 
	<span class="token property">&quot;createdAt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2017-07-23T23:51:46.478440258+01:00&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;deployment update&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;LevelError&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="release-notes-in-notifications"><a href="#release-notes-in-notifications" aria-hidden="true" class="header-anchor">#</a> Release notes in notifications</h3> <p>You can optionally set a release notes link (or anything that's allowed by <code>annotation</code> value or Helm chart value) in your configuration.</p> <p>If you are using Kubernetes, use annotation <code>keel.sh/releaseNotes</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;wd&quot;</span>
      <span class="token key atrule">keel.sh/policy</span><span class="token punctuation">:</span> minor
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">keel.sh/releaseNotes</span><span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/keel-hq/keel/releases&quot;</span>
</code></pre></div><p>If you are using Helm, your Keel config now accepts <code>releaseNotes</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> app1
<span class="token key atrule">image</span><span class="token punctuation">:</span>
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> gcr.io/v2<span class="token punctuation">-</span>namespace/hello<span class="token punctuation">-</span>world
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> 1.1.0

<span class="token key atrule">keel</span><span class="token punctuation">:</span>  
  <span class="token key atrule">policy</span><span class="token punctuation">:</span> force  
  <span class="token key atrule">trigger</span><span class="token punctuation">:</span> poll  
  <span class="token key atrule">images</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">repository</span><span class="token punctuation">:</span> image.repository
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> image.tag
      <span class="token key atrule">releaseNotes</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/keel<span class="token punctuation">-</span>hq/keel/releases			

</code></pre></div><p>Release notes will be sent with a successful update.</p> <h3 id="webhook-notifications"><a href="#webhook-notifications" aria-hidden="true" class="header-anchor">#</a> Webhook notifications</h3> <p>To enabled webhook notifications provide an endpoint via <strong>WEBHOOK_ENDPOINT</strong> environment variable inside Keel deployment.</p> <p>Webhook payload sample:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;update deployment&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Successfully updated deployment default/wd (karolisr/webhook-demo:0.0.10)&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;createdAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-07-08T10:08:45.226565869+01:00&quot;</span>	
<span class="token punctuation">}</span>
</code></pre></div><h3 id="slack-notifications"><a href="#slack-notifications" aria-hidden="true" class="header-anchor">#</a> Slack notifications</h3> <p><img src="/img/docs/slack-notifications.png" alt="Slack notifications"></p> <p>First, get a Slack token, info about that can be found in the <a href="https://get.slack.help/hc/en-us/articles/215770388-Create-and-regenerate-API-tokens" target="_blank" rel="noopener noreferrer">docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Then, provide token via <strong>SLACK_TOKEN</strong> environment variable. You should also provide <strong>SLACK_CHANNELS</strong> environment variable with a comma separated list of channels where these notifications should be delivered to.</p> <p>Keel will be sending messages when deployment updates succeed or fail.</p> <h3 id="hipchat-notifications"><a href="#hipchat-notifications" aria-hidden="true" class="header-anchor">#</a> HipChat notifications</h3> <div class="warning custom-block"><p>HipChat documentation is missing, if you are using it, please add some examples.</p></div> <h3 id="mattermost-notifications"><a href="#mattermost-notifications" aria-hidden="true" class="header-anchor">#</a> Mattermost notifications</h3> <p><a href="https://about.mattermost.com/" target="_blank" rel="noopener noreferrer">Mattermost<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is an open source Slack alternative, it's written in Go and React.</p> <p>If you don't have a Mattermost server, you can set one up by using Docker:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run --name mattermost-preview -d --publish 8065:8065 mattermost/mattermost-preview
</code></pre></div><p>Server should be reachable on: http://localhost:8065/</p> <p>Now, enable &quot;incoming webhooks&quot; in your Mattermost server. Documentation can be found <a href="https://docs.mattermost.com/developer/webhooks-incoming.html" target="_blank" rel="noopener noreferrer">in the incoming webhooks section<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <p><img src="/img/docs/mattermost-webhooks.png" alt="Mattermost webhooks"></p> <p>Also, you should enable icon and username override so users know that webhooks are coming from Keel:</p> <p><img src="/img/docs/mattermost-icon-username.png" alt="Mattermost username and icon override"></p> <p>Now, set <code>MATTERMOST_ENDPOINT</code> environment variable for Keel with your Mattermost webhook endpoint:</p> <p><img src="/img/docs/mattermost-configuration.png" alt="Mattermost configuration"></p> <p>That's it, Keel notifications for Mattermost enabled:</p> <p><img src="/img/docs/mattermost-notification.png" alt="Mattermost notification"></p> <blockquote><p>If you want to override bot's username, you can supply <code>MATTERMOST_USERNAME=somethingelse</code> environment variable.</p></blockquote> <h3 id="notification-levels"><a href="#notification-levels" aria-hidden="true" class="header-anchor">#</a> Notification levels</h3> <p>Set notification levels via <code>NOTIFICATION_LEVEL</code> environment variable. Available levels: debug, info, success, warn, error, fatal. This setting defaults to <code>info</code>.</p> <h3 id="overriding-default-channels-per-deployment"><a href="#overriding-default-channels-per-deployment" aria-hidden="true" class="header-anchor">#</a> Overriding default channels per deployment</h3> <p>Some notification providers such as Slack and Hipchat allow apps to send notifications to multiple channels.</p> <p>For standard Kubernetes deployments use annotation with channels separated by commas: <code>keel.sh/notify=channelName1,channelName2</code>.</p> <p><img src="/img/docs/notify-per-deployment.png" alt="notifications per deployment"></p> <p>For Helm chart please specify <code>notificationChannels</code> string list to Keel config section in <em>values.yaml</em>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">notificationChannels</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> chan1
  <span class="token punctuation">-</span> chan2
</code></pre></div><p>Your <em>values.yaml</em> should look like this:</p> <p><img src="/img/docs/notify-per-chart.png" alt="notifications per chart"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/keel-hq/keel.sh/edit/master/docs/README.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.36122d6f.js" defer></script><script src="/assets/js/2.dacee0f1.js" defer></script><script src="/assets/js/7.b6f9273d.js" defer></script><script src="/assets/js/3.3918a260.js" defer></script>
  </body>
</html>
